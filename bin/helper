#!/bin/bash

COMMAND=$1
LATEST_ALPINE_VERSION=3.17
FALLBACK_VERSION_80="8.0.28"
FALLBACK_VERSION_81="8.1.17"
FALLBACK_VERSION_82="8.2.4"

if [[ $COMMAND == alpineversion ]]
then

  BRANCH=${2:-${LATEST_ALPINE_VERSION}}
  API_URL="https://hub.docker.com/v2/repositories/library/alpine/tags?page_size=100"
  JQ=$(which jq) || bin/jq-osx-amd64
  TAGS=$(curl -L -s "$API_URL" | $JQ --raw-output '."results"[]["name"]')

  for TAG in $TAGS
  do
    if [[ $TAG == $BRANCH.* ]]
    then
      # First found tag is also the latest
      echo "$TAG" && exit 0
    fi
  done

fi

if [[ $COMMAND == phpminor ]]
then

  BRANCH=${2:-8.0}
  #ALPINE=${LATEST_ALPINE_VERSION}

  if [[ $BRANCH == 8.1 ]]
  then
    URL="https://git.alpinelinux.org/aports/plain/community/php81/APKBUILD"
  elif [[ $BRANCH == 8.2 ]]
  then
    URL="https://git.alpinelinux.org/aports/plain/community/php82/APKBUILD"
  else
    URL="https://git.alpinelinux.org/aports/plain/testing/php8/APKBUILD"
  fi

  RESPONSE=$(curl -s -w "%{http_code}" "$URL")
  CODE=$(tail -n1 <<< "$RESPONSE")
  RESPONSE=$(sed '$ d' <<< "$RESPONSE")

  if [[ "$CODE" =~ ^2 ]]; then
      echo "$RESPONSE" | cat | grep -m 1 -i "pkgver=" | cut -d "=" -f2 && exit 0
  else
      if [[ "$BRANCH" == "8.0" ]]; then echo "$FALLBACK_VERSION_80"; fi
      if [[ "$BRANCH" == "8.1" ]]; then echo "$CODE $FALLBACK_VERSION_81"; fi
      if [[ "$BRANCH" == "8.2" ]]; then echo "$CODE $FALLBACK_VERSION_82"; fi
      exit 0
  fi

fi

echo "No valid arguments given" && exit 1
